<hr />

<p>이제 진짜 배포까지 완료했다. 재밌으니까 링크도 한번 걸어놔본다. 누가와서 써도 내가 관리하러도 잘 안 들어가기때문에 뭐 어떻게든 되겠지 싶다.</p>

<p><a href="https://ubiquitous-heliotrope-94127b.netlify.app/">Dwitter</a></p>

<p>아마 나중에 발견했다면 배포가 끊어져 닫혀있지않을까 싶다 ㅋㅋㅋ</p>

<p>배포하는 과정에서 정말정말정말 많은 오류가 있었고, 생각보다 많은 시간을 들여서 배포를 완료했다.</p>

<p>코드를 한번 봐보자.</p>

<p>우선은 configuration 을 담당하는 config.js이다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">dotenv</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">dotenv</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">dotenv</span><span class="p">.</span><span class="nf">config</span><span class="p">();</span>

<span class="kd">function</span> <span class="nf">required</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">defalutValue</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">||</span> <span class="nx">defalutValue</span><span class="p">;</span>
    <span class="nf">if </span><span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="s2">`key </span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2"> is undefined!`</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">jwt</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">secretKey</span><span class="p">:</span> <span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">JWT_SECRET</span><span class="dl">"</span><span class="p">),</span>
        <span class="na">expriesInSec</span><span class="p">:</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">JWT_EXPRIES_SEC</span><span class="dl">"</span><span class="p">,</span> <span class="mi">86400</span><span class="p">)),</span>
    <span class="p">},</span>
    <span class="na">bcrypt</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">saltRounds</span><span class="p">:</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">BCRYPT_SALT_ROUNDS</span><span class="dl">"</span><span class="p">,</span> <span class="mi">12</span><span class="p">)),</span>
    <span class="p">},</span>
    <span class="na">port</span><span class="p">:</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">PORT</span><span class="dl">"</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)),</span>

    <span class="na">db</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">host</span><span class="p">:</span> <span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">DB_HOST</span><span class="dl">"</span><span class="p">),</span>
        <span class="na">user</span><span class="p">:</span> <span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">DB_USER</span><span class="dl">"</span><span class="p">),</span>
        <span class="na">database</span><span class="p">:</span> <span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">DB_DATABASE</span><span class="dl">"</span><span class="p">),</span>
        <span class="na">password</span><span class="p">:</span> <span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">DB_PASSWORD</span><span class="dl">"</span><span class="p">),</span>
        <span class="na">port</span><span class="p">:</span> <span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">DB_PORT</span><span class="dl">"</span><span class="p">),</span>
    <span class="p">},</span>

    <span class="na">cors</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">allowedOrigin</span><span class="p">:</span> <span class="nf">required</span><span class="p">(</span><span class="dl">"</span><span class="s2">CORS_ALLOW_ORIGIN</span><span class="dl">"</span><span class="p">),</span>
    <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>첫번째로 마주한 오류는 단순한 오타였다. 나는 왜 secret의 스펠링이 secert으로 알고있었나 싶다. 진짜 바보같이 뭐가 오류인지도 못찾고 어버버버버 하다가 발견했다 ㅋㅋㅋ 이때부터 좀 멘탈이 나가있었던 거 같다.</p>

<p>.env파일은 비밀이니까 비밀로하겠다. 비밀.</p>

<p>다음으로 app.js 파일을 한번 살펴보자.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">express-async-errors</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">cors</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">cors</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">helmet</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">helmet</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">morgan</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">morgan</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">tweetsRouter</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./router/tweets.js</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">authRouter</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./router/auth.js</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">sequelize</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./db/database.js</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">config</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./config.js</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">initSocket</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./connection/socket.js</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">corsOption</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">origin</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">cors</span><span class="p">.</span><span class="nx">allowedOrigin</span><span class="p">,</span>
    <span class="na">optionsSuccessStatus</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
<span class="p">};</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nf">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cors</span><span class="p">(</span><span class="nx">corsOption</span><span class="p">));</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">helmet</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">morgan</span><span class="p">(</span><span class="dl">"</span><span class="s2">tiny</span><span class="dl">"</span><span class="p">));</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="dl">"</span><span class="s2">/tweets</span><span class="dl">"</span><span class="p">,</span> <span class="nx">tweetsRouter</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="dl">"</span><span class="s2">/auth</span><span class="dl">"</span><span class="p">,</span> <span class="nx">authRouter</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">마지막에 걸러짐</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">sendStatus</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">((</span><span class="nx">error</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">sendStatus</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">sequelize</span><span class="p">.</span><span class="nf">sync</span><span class="p">().</span><span class="nf">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">init Server!</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
    <span class="nf">initSocket</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>두번째로, cors에 관련된 이해가 부족했다. 그냥 “아! 남들이 맘대로 내 웹사이트 베껴가면 안되니까 설정하는게 cors구나라고 개념만 이해하고, *로 그냥 모든 곳에서 허용하다가보니 좀 더 까먹었던 거 같다. cors_allow_origin의 값에 프론트 url을 넣어줌으로써 하나의 오류를 해결했다.”</p>

<p>마지막으로 배포를 하는 과정에서 나는 로컬호스트의 존재는 아예 없어진다고 생각했다. 그리고 나오는 DB_PORT를 어! 저것만 연동하면 되나? 하고서 코드를 아래와 같이 짰다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">sequelize</span><span class="p">.</span><span class="nf">sync</span><span class="p">().</span><span class="nf">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">init Server!</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span> <span class="c1">//요기</span>
    <span class="nf">initSocket</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>배포는 처음해봤으니까… 아무리 멍청해보여도 앞으로 확실히 알았으니 기분은 좋다.</p>

<p>앞으로는 정신차리구 잘 해야지!</p>

<p><img src="../../../assets/img/Project/dwitter/dwitter1.png" alt="dwitter5" /></p>

<p><img src="../../../assets/img/Project/dwitter/dwitter2.png" alt="dwitter6" /></p>

