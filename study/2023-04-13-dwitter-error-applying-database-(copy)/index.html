<hr />

<p>Dwitter 를 쳤는데 자꾸 자동완성으로 Twitter으로 된다. Dwitter은 내가 만든건데,,</p>

<p>blog를 만든 시점이 이미 dwitter를 많이 구현한 시점이라서 여기서부터 시작하는점은 좀 아쉽다.</p>

<p>api설계부터 차근차근 블로그에 정리해뒀으면 좋았을 거 같다는 생각은 들지만 이미 지난 건 어쩔 수 없으니 지금부터라도 뭔가 막힌걸 해결했을 때, 블로그에다가 오류내용을 남겨보려고 한다.</p>

<p>사실 이번 오류는 단순한 오타에서 발생한 것이였다. 하지만 오류가 발생했을때, 오류가 생기는 원인에 대해서 사람들에게 자문을 구했던 내용이 중요하다고 생각되어 정리할겸 블로그에 글을 쓴다.</p>

<p>우선 오류는, 원래 client와 server을 npm start로 구동시켰을때 잘 되었다. 그 때 당시에는 tweet들의 데이터들을 그냥 객체로 보관했었는데 database(mysql)과 연동시키면서 변수에 저장되어있던 내용들을 삭제한 후, CRUD하는 부분또한 db와 연동시켜 sql문을 작성하여 적용하고자 하였다. 아래는 이전코드이다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">userRepository</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./auth.js</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">tweets</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">안녕하세오 1번 트윗입니다.</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">createdAt</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">().</span><span class="nf">toString</span><span class="p">(),</span>
    <span class="na">userId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">2</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">안녕하세오 2번 트윗이에요.</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">createdAt</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">().</span><span class="nf">toString</span><span class="p">(),</span>
    <span class="na">userId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">];</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">getAll</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nf">all</span><span class="p">(</span>
    <span class="nx">tweets</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nf">async </span><span class="p">(</span><span class="nx">tweet</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">url</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span>
        <span class="nx">tweet</span><span class="p">.</span><span class="nx">userId</span>
      <span class="p">);</span>
      <span class="k">return</span> <span class="p">{</span> <span class="p">...</span><span class="nx">tweet</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">url</span> <span class="p">};</span>
    <span class="p">})</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">getAllByUsername</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nf">getAll</span><span class="p">().</span><span class="nf">then</span><span class="p">((</span><span class="nx">tweets</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">tweets</span><span class="p">.</span><span class="nf">filter</span><span class="p">((</span><span class="nx">tweet</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">username</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">getById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">tweets</span><span class="p">.</span><span class="nf">find</span><span class="p">((</span><span class="nx">tweet</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">);</span>
  <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">url</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">userRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nx">found</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span> <span class="p">...</span><span class="nx">found</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">url</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">create</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">tweet</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">().</span><span class="nf">toString</span><span class="p">(),</span>
    <span class="nx">text</span><span class="p">,</span>
    <span class="na">createdAt</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(),</span>
    <span class="nx">userId</span><span class="p">,</span>
  <span class="p">};</span>
  <span class="nx">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="nx">tweet</span><span class="p">,</span> <span class="p">...</span><span class="nx">tweets</span><span class="p">];</span>
  <span class="k">return</span> <span class="nf">getById</span><span class="p">(</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">tweet</span> <span class="o">=</span> <span class="nx">tweets</span><span class="p">.</span><span class="nf">find</span><span class="p">((</span><span class="nx">tweet</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">);</span>
  <span class="nf">if </span><span class="p">(</span><span class="nx">tweet</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tweet</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nf">getById</span><span class="p">(</span><span class="nx">tweet</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">remove</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">tweets</span> <span class="o">=</span> <span class="nx">tweets</span><span class="p">.</span><span class="nf">filter</span><span class="p">((</span><span class="nx">tweet</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">tweet</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>그리고 db를 적용한 코드는 아래와 같다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">userRepository</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../data/auth.js</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">db</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../db/database.js</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">SELECT_JOIN</span> <span class="o">=</span>
    <span class="dl">"</span><span class="s2">SELECT tw.id, tw.text, tw.createdAt, tw.userId, us.username, us.url FROM tweets as tw JOIN users as us ON tw.userId = us.id</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">ORDER_DESC</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">ORDER BY tw.createdAt DESC</span><span class="dl">"</span><span class="p">;</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">getAll</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span>
        <span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">SELECT_JOIN</span><span class="p">}</span><span class="s2"> </span><span class="p">${</span><span class="nx">ORDER_DESC</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span> <span class="c1">//</span>
        <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">getAllByUsername</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span>
        <span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">SELECT_JOIN</span><span class="p">}</span><span class="s2"> WHERE username=? </span><span class="p">${</span><span class="nx">ORDER_DESC</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="p">[</span><span class="nx">username</span><span class="p">])</span> <span class="c1">//</span>
        <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">getById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span>
        <span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">SELECT_JOIN</span><span class="p">}</span><span class="s2"> WHERE tw.id=?`</span><span class="p">,</span> <span class="p">[</span><span class="nx">id</span><span class="p">])</span> <span class="c1">//</span>
        <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">create</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span>
        <span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="dl">"</span><span class="s2">INSERT INTO tweets (text, createdAt, userId) VALUES(?,?,?)</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">text</span><span class="p">,</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(),</span> <span class="nx">userId</span><span class="p">])</span>
        <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">getById</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">insertId</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="dl">"</span><span class="s2">UPDATE tweets SET text=? WHERE id=?</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">text</span><span class="p">,</span> <span class="nx">id</span><span class="p">]).</span><span class="nf">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nf">getById</span><span class="p">(</span><span class="nx">id</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">remove</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="dl">"</span><span class="s2">DELETE FROM tweets WHERE id=?</span><span class="dl">"</span><span class="p">,</span> <span class="p">[</span><span class="nx">id</span><span class="p">]);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>근데 어라 postman으로 요청을 날리면 거기서의 res값은 야무지게 다 들어오는 것 같은데 왜인지 프론트엔드에서 tweet들을 불러오는게 계속 오류가 났었다.</p>

<p>알고보니 그냥 db에서 SELECT문을 하는 과정에서 us.name도 받아왔어야 했는데 그걸 누락해서 그런거였지만, 그 오류를 찾는 과정에서 동작구조를 조금 더 세밀히 살피게 되었고,  res값이 잘 나오는 거 같더라도 계속 의심해야겠다고 생각하게 되었다.</p>

<p>작년에 학교에서 배웠던 데이터베이스가 이렇게 쓰이니 신기해도 보였다. 너무 재밌다.</p>
