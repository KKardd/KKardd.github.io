<hr />

<p><img src="/assets/img/Project/nogwari/erd2.png" alt="" /></p>

<p>아직 FE는 시작도 안했지만,, 나는 테이블 조인단계에 벌써 들어와버렸다. 이번 글은 조인하면서 방황한 일에 간단하게 정의하고 글을 끝내려고 한다. 글은 짧아도 이걸로 6시간은 방황한 거 같으니 기분나빠서라도 써야겠다.</p>

<p>사실 ORM을 쓰기때문에, join이라고 말하기는 어렵지만, board 한개에 포함되어야하는 내용은 위에 ERD에서 보이는 값들 뿐 아니라, user의 profile img, nickname, grade까지 보여주는게 맞다고 생각했다. 그래서 코드를 아래와 같이 작성하였다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Board User 일대일관계</span>
<span class="nx">User</span><span class="p">.</span><span class="nf">hasOne</span><span class="p">(</span><span class="nx">Board</span><span class="p">);</span>
<span class="nx">Board</span><span class="p">.</span><span class="nf">belongsTo</span><span class="p">(</span><span class="nx">User</span><span class="p">);</span>
<span class="c1">// Board Category 일대일관계</span>
<span class="nx">Category</span><span class="p">.</span><span class="nf">hasOne</span><span class="p">(</span><span class="nx">Board</span><span class="p">);</span>
<span class="nx">Board</span><span class="p">.</span><span class="nf">belongsTo</span><span class="p">(</span><span class="nx">Category</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">INCLUDED_ALL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">hits</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">views</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">dislikes</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">reported</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">createdAt</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">updatedAt</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">userId</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">categoryId</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">[</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="dl">"</span><span class="s2">user.nickn  ame</span><span class="dl">"</span><span class="p">),</span> <span class="dl">"</span><span class="s2">userNickname</span><span class="dl">"</span><span class="p">],</span>
        <span class="p">[</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="dl">"</span><span class="s2">user.img</span><span class="dl">"</span><span class="p">),</span> <span class="dl">"</span><span class="s2">userImg</span><span class="dl">"</span><span class="p">],</span>
        <span class="p">[</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="dl">"</span><span class="s2">user.grade</span><span class="dl">"</span><span class="p">),</span> <span class="dl">"</span><span class="s2">userGrade</span><span class="dl">"</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="na">include</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="na">model</span><span class="p">:</span> <span class="nx">User</span><span class="p">,</span>
            <span class="na">attributes</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
    <span class="p">],</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">ORDER_DESC</span> <span class="o">=</span> <span class="p">{</span><span class="na">order</span><span class="p">:</span> <span class="p">[[</span><span class="dl">"</span><span class="s2">createdAt</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">DESC</span><span class="dl">"</span><span class="p">]]};</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">getAllbyPages</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Board</span><span class="p">.</span><span class="nf">findAll</span><span class="p">({</span>
        <span class="p">...</span><span class="nx">INCLUDED_ALL</span><span class="p">,</span>
        <span class="p">...</span><span class="nx">ORDER_DESC</span><span class="p">,</span>
        <span class="na">where</span><span class="p">:</span> <span class="p">{</span><span class="na">hidden</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>INCLUDED_ALL이라는 변수는 attribute를 일일이 쓰기 번거로워서 저렇게 변수로 빼두었다. INCLUDED_ALL변수는 저런식으로 attribute와 include를 포함하고 있는데, 저런식으로 include안 배열에 model를 User로 정의함으로써 조인? 비슷하게 작동하는 걸로 알고있었다.</p>

<p>근데 진행하다보니 한개의 board안에서는 User에서 저 세개뿐아니라 Category테이블에서 Category.name도 받아와야한다. 그게 진정한 board라고 생각하였기 때문에, 수정하고자 하였다.</p>

<p>근데 두개의 테이블을 조인하는 과정에서 어려움을 겪었는데, 알고보니 include는 배열형태로 받고 각각 다른 객체를 선언하면 두개의 테이블을 동시에 조인하는게 된다는 걸 진짜 끝없는 방황끝에 깨달았다 ㅎ</p>

<p>뭐 여튼 깨달았으면 오케이 아닐까요?</p>

<p>아래는 수정된 INCLUDED_ALL 변수 코드이다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">INCLUDED_ALL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">attributes</span><span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">content</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">hits</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">views</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">dislikes</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">reported</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">createdAt</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">updatedAt</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">userId</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">categoryId</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">[</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="dl">"</span><span class="s2">user.nickn  ame</span><span class="dl">"</span><span class="p">),</span> <span class="dl">"</span><span class="s2">userNickname</span><span class="dl">"</span><span class="p">],</span>
        <span class="p">[</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="dl">"</span><span class="s2">user.img</span><span class="dl">"</span><span class="p">),</span> <span class="dl">"</span><span class="s2">userImg</span><span class="dl">"</span><span class="p">],</span>
        <span class="p">[</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="dl">"</span><span class="s2">user.grade</span><span class="dl">"</span><span class="p">),</span> <span class="dl">"</span><span class="s2">userGrade</span><span class="dl">"</span><span class="p">],</span>
        <span class="p">[</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nf">col</span><span class="p">(</span><span class="dl">"</span><span class="s2">category.name</span><span class="dl">"</span><span class="p">),</span> <span class="dl">"</span><span class="s2">categoryName</span><span class="dl">"</span><span class="p">],</span>
    <span class="p">],</span>
    <span class="na">include</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="na">model</span><span class="p">:</span> <span class="nx">User</span><span class="p">,</span>
            <span class="na">attributes</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">},</span> <span class="c1">// model을 두개 정의하는 법을 이렇게 하면 되는구나!</span>
        <span class="p">{</span>
            <span class="na">model</span><span class="p">:</span> <span class="nx">Category</span><span class="p">,</span>
            <span class="na">attributes</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">},</span>
    <span class="p">],</span>
<span class="p">};</span>
</code></pre></div></div>

<p><img src="/assets/img/Project/nogwari/board1.png" alt="" /></p>
